zabbix_export:
  version: '5.4'
  date: '2021-05-09T00:00:00Z'
  groups:
    -
      uuid: 57b7ae836ca64446ba2c296389c009b7
      name: Templates/Modules
  templates:
    -
      uuid: 07b32152c3654e8ead4c1eeae24efa8f
      template: 'Morningstar TriStar MPPT SNMP'
      name: 'Morningstar TriStar MPPT SNMP'
      description: |
        MIBs used:
        TRISTAR-MPPT
        
        Template tooling version used: 0.38
      groups:
        -
          name: Templates/Modules
      items:
        -
          uuid: 2c3dcfd83bf946fb9da84f648c1efbac
          name: 'Array: Array Current'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.31.0
          key: 'array.current[arrayCurrent.0]'
          history: 7d
          value_type: FLOAT
          units: A
          description: |
            MIB: TRISTAR-MPPT
            Description:Array Current
            Scaling Factor:0.00244140625
            Units:A
            Range:[-10, 80]
            Modbus address:0x001d
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.00244140625'
            -
              type: REGEX
              parameters:
                - '^(\d+)(\.\d{1,2})?'
                - \1\2
          tags:
            -
              tag: Application
              value: Array
        -
          uuid: 53c1cccd0262422eb18bb6745adb2369
          name: 'Array: Sweep Pmax'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.33.0
          key: 'array.sweep_pmax[arrayPmaxLastSweep.0]'
          history: 7d
          value_type: FLOAT
          units: W
          description: |
            MIB: TRISTAR-MPPT
            Description:Pmax (last sweep)
            Scaling Factor:0.10986328125
            Units:W
            Range:[-10, 5000]
            Modbus address:0x003c
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.1098632813'
            -
              type: REGEX
              parameters:
                - '^(\d+)(\.\d{1,2})?'
                - \1\2
          tags:
            -
              tag: Application
              value: Array
        -
          uuid: 2f0bbf8b6d53457283069aaf8e0386ae
          name: 'Array: Sweep Vmp'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.34.0
          key: 'array.sweep_vmp[arrayVmpLastSweep.0]'
          history: 7d
          value_type: FLOAT
          units: V
          description: |
            MIB: TRISTAR-MPPT
            Description:Vmp (last sweep)
            Scaling Factor:0.0054931640625
            Units:V
            Range:[-10, 180.0]
            Modbus address:0x003d
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.005493164063'
            -
              type: REGEX
              parameters:
                - '^(\d+)(\.\d{1,2})?'
                - \1\2
          tags:
            -
              tag: Application
              value: Array
        -
          uuid: ced0f7c4abb6409399a9e05797841497
          name: 'Array: Sweep Voc'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.35.0
          key: 'array.sweep_voc[arrayVocLastSweep.0]'
          history: 7d
          value_type: FLOAT
          units: V
          description: |
            MIB: TRISTAR-MPPT
            Description:Voc (last sweep)
            Scaling Factor:0.0054931640625
            Units:V
            Range:[-10, 180.0]
            Modbus address:0x003e
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.005493164063'
            -
              type: REGEX
              parameters:
                - '^(\d+)(\.\d{1,2})?'
                - \1\2
          tags:
            -
              tag: Application
              value: Array
        -
          uuid: 419b9faf88284121a8806c60c8a4550d
          name: 'Array: Voltage'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.30.0
          key: 'array.voltage[arrayVoltage.0]'
          history: 7d
          value_type: FLOAT
          units: V
          description: |
            MIB: TRISTAR-MPPT
            Description:Array Voltage
            Scaling Factor:0.0054931640625
            Units:V
            Range:[-10, 180]
            Modbus address:0x001b
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.005493164063'
            -
              type: REGEX
              parameters:
                - '^(\d+)(\.\d{1,2})?'
                - \1\2
          tags:
            -
              tag: Application
              value: Array
        -
          uuid: f40795d2c28b4f53ac50399ca6e6f8d6
          name: 'Battery: Battery Voltage discovery'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.36.0
          key: 'battery.voltage.discovery[batteryVoltage.0]'
          delay: 15m
          history: '0'
          value_type: FLOAT
          units: V
          description: 'MIB: TRISTAR-MPPT'
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.005493164063'
          tags:
            -
              tag: Application
              value: 'Zabbix raw items'
        -
          uuid: e1646c9847064d53913d9c57d1b59de7
          name: 'Battery: Charge Current'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.42.0
          key: 'charge.current[batteryCurrent.0]'
          history: 7d
          value_type: FLOAT
          units: A
          description: |
            MIB: TRISTAR-MPPT
            Description:Battery Current
            Scaling Factor:0.00244140625
            Units:A
            Range:[-10, 80]
            Modbus address:0x001c
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.00244140625'
            -
              type: REGEX
              parameters:
                - '^(\d+)(\.\d{1,2})?'
                - \1\2
          tags:
            -
              tag: Application
              value: Battery
        -
          uuid: e70284aa07924a61add98dc516f0429e
          name: 'Battery: Output Power'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.44.0
          key: 'charge.output_power[ outputPower.0]'
          history: 7d
          value_type: FLOAT
          units: W
          description: |
            MIB: TRISTAR-MPPT
            Description:Output Power
            Scaling Factor:0.10986328125
            Units:W
            Range:[-10, 5000]
            Modbus address:0x003a
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.1098632813'
            -
              type: REGEX
              parameters:
                - '^(\d+)(\.\d{1,2})?'
                - \1\2
          tags:
            -
              tag: Application
              value: Battery
        -
          uuid: 7ad0e0153d6342a5bdd1576b2ad815e3
          name: 'Battery: Charge State'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.46.0
          key: 'charge.state[chargeState.0]'
          history: 7d
          value_type: FLOAT
          description: |
            MIB: TRISTAR-MPPT
            Description:Charge State
            Modbus address:0x0032
            
            0: Start
            1: NightCheck
            2: Disconnect
            3: Night
            4: Fault
            5: Mppt
            6: Absorption
            7: Float
            8: Equalize
            9: Slave
          valuemap:
            name: 'TriStar MPPT charge state'
          preprocessing:
            -
              type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          tags:
            -
              tag: Application
              value: Battery
          triggers:
            -
              uuid: 1bf38cc1b1ec4eafac51ff5e9b868a06
              expression: '{last()}={$CHARGE.STATE.CRIT}'
              name: 'Battery: Device charge in critical state'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: 49d8cc5dfb7d48c28db40fbc902891e3
              expression: '{last()}={$CHARGE.STATE.WARN}'
              name: 'Battery: Device charge in warning state'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
              dependencies:
                -
                  name: 'Battery: Device charge in critical state'
                  expression: '{Morningstar TriStar MPPT SNMP:charge.state[chargeState.0].last()}={$CHARGE.STATE.CRIT}'
        -
          uuid: 48db3379939b4698b8f30ff7118a9a95
          name: 'Counter: Charge Amp-hours'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.50.0
          key: 'counter.charge_amp_hours[ahChargeResetable.0]'
          history: 7d
          value_type: FLOAT
          units: Ah
          description: |
            MIB: TRISTAR-MPPT
            Description:Ah Charge Resettable
            Scaling Factor:0.1
            Units:Ah
            Range:[0.0, 5000]
            Modbus addresses:H=0x0034 L=0x0035
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.1'
          tags:
            -
              tag: Application
              value: Counter
        -
          uuid: f14eb25c426141d1875d5828b5c62c30
          name: 'Counter: Charge KW-hours'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.52.0
          key: 'counter.charge_kw_hours[kwhChargeResetable.0]'
          history: 7d
          units: '!kWh'
          description: |
            MIB: TRISTAR-MPPT
            Description:kWh Charge Resettable
            Scaling Factor:0.1
            Units:kWh
            Range:[0.0, 65535.0]
            Modbus address:0x0038
          tags:
            -
              tag: Application
              value: Counter
        -
          uuid: 5c96236f9623495289b94bd4d63e6faf
          name: 'Status: Alarms'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.57.0
          key: 'status.alarms[alarms.0]'
          history: 1h
          trends: '0'
          value_type: TEXT
          description: |
            MIB: TRISTAR-MPPT
            Description:Faults
            Modbus address:0x002c
          preprocessing:
            -
              type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
            -
              type: JAVASCRIPT
              parameters:
                - |
                  var FIELDS = [
                    'rtsOpen',
                    'rtsShorted',
                    'rtsDisconnected',
                    'heatsinkTempSensorOpen',
                    'heatsinkTempSensorShorted',
                    'highTemperatureCurrentLimit',
                    'currentLimit',
                    'currentOffset',
                    'batterySense',
                    'batterySenseDisconnected',
                    'uncalibrated',
                    'rtsMiswire',
                    'highVoltageDisconnect',
                    'undefined',
                    'systemMiswire',
                    'mosfetSOpen',
                    'p12VoltageReferenceOff',
                    'highArrayVCurrentLimit',
                    'maxAdcValueReached',
                    'controllerWasReset',
                  ];
                  
                  var flags = parseInt(value.replace(/\x20/g, ''), 16),
                    result = [];
                  
                  for (var i = 0, f = 1 << 31 >>> 0, l = FIELDS.length; i < l; i++, f >>>= 1) {
                      if (flags & f) {
                          result.push(FIELDS[i]);
                      }
                  }
                  
                  return result.length ? result.join('\n') : 'No alarms';
          tags:
            -
              tag: Application
              value: Status
          triggers:
            -
              uuid: d5da4e4c67f644c8941ba92b8f68cddd
              expression: '{count(#3,"batterySense","like")}=2'
              name: 'Status: Device has "batterySense" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 911232ea871942fbb0f3f868b80a9b42
              expression: '{count(#3,"batterySenseDisconnected","like")}=2'
              name: 'Status: Device has "batterySenseDisconnected" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: e6d5d0b5906942b589cf59fa36e0b349
              expression: '{count(#3,"controllerWasReset","like")}=2'
              name: 'Status: Device has "controllerWasReset" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: ca18bf0334304350aff5e40f606f5487
              expression: '{count(#3,"currentLimit","like")}=2'
              name: 'Status: Device has "currentLimit" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 71bb6c2c558e44479eef944bd9f97e24
              expression: '{count(#3,"currentOffset","like")}=2'
              name: 'Status: Device has "currentOffset" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 1ee2f4779359437b966b669578270995
              expression: '{count(#3,"heatsinkTempSensorOpen","like")}=2'
              name: 'Status: Device has "heatsinkTempSensorOpen" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: c675c91c3a1b4ad49d398e7033cbe597
              expression: '{count(#3,"heatsinkTempSensorShorted","like")}=2'
              name: 'Status: Device has "heatsinkTempSensorShorted" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 5079a3fd8c524121ab3e3364cde2bdd1
              expression: '{count(#3,"highArrayVCurrentLimit","like")}=2'
              name: 'Status: Device has "highArrayVCurrentLimit" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 684ab5896d4d46b2840843404e0755de
              expression: '{count(#3,"highTemperatureCurrentLimit","like")}=2'
              name: 'Status: Device has "highTemperatureCurrentLimit" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: c0ecaabdbd75425ba039df8912858962
              expression: '{count(#3,"highVoltageDisconnect","like")}=2'
              name: 'Status: Device has "highVoltageDisconnect" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 94391b98ef4243ebb7faa5b505bde797
              expression: '{count(#3,"maxAdcValueReached","like")}=2'
              name: 'Status: Device has "maxAdcValueReached" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: b97258281153468bbd70ef72687cd5d8
              expression: '{count(#3,"mosfetSOpen","like")}=2'
              name: 'Status: Device has "mosfetSOpen" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 29d74d9802624c909d112229a5bc4581
              expression: '{count(#3,"p12VoltageReferenceOff","like")}=2'
              name: 'Status: Device has "p12VoltageReferenceOff" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 436b189c825343d598837bf00df23b70
              expression: '{count(#3,"rtsDisconnected","like")}=2'
              name: 'Status: Device has "rtsDisconnected" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 7a26b820992241e997da4dc717975165
              expression: '{count(#3,"rtsMiswire","like")}=2'
              name: 'Status: Device has "rtsMiswire" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 60071893224643f98910705242ce87e4
              expression: '{count(#3,"rtsShorted","like")}=2'
              name: 'Status: Device has "rtsShorted" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: b9abd6947f40446793e94ca8fee19f12
              expression: '{count(#3,"systemMiswire","like")}=2'
              name: 'Status: Device has "systemMiswire" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
            -
              uuid: 2854705667fe468f9e892d1b72effda4
              expression: '{count(#3,"uncalibrated","like")}=2'
              name: 'Status: Device has "uncalibrated" alarm flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
        -
          uuid: 64a01cde330e437499a719237f68fda2
          name: 'Status: Faults'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.55.0
          key: 'status.faults[faults.0]'
          history: 1h
          trends: '0'
          value_type: TEXT
          description: |
            MIB: TRISTAR-MPPT
            Description:Faults
            Modbus address:0x002c
          preprocessing:
            -
              type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
            -
              type: JAVASCRIPT
              parameters:
                - |
                  var FIELDS = [
                    'overcurrent',
                    'fetShort',
                    'softwareFault',
                    'batteryHvd',
                    'arrayHvd',
                    'dipSwitchChange',
                    'customSettingsEdit',
                    'rtsShorted',
                    'rtsDisconnected',
                    'eepromRetryLimit',
                    'fault11Undefined',
                    'slaveControlTimeout',
                  ];
                  
                  var flags = parseInt(value.replace(/\x20/g, ''), 16),
                    result = [];
                  
                  for (var i = 0, f = 1 << 31 >>> 0, l = FIELDS.length; i < l; i++, f >>>= 1) {
                      if (flags & f) {
                          result.push(FIELDS[i]);
                      }
                  }
                  
                  return result.length ? result.join('\n') : 'No faults';
          tags:
            -
              tag: Application
              value: Status
          triggers:
            -
              uuid: 71951818fa0d40878b61649d8b8c6924
              expression: '{count(#3,"arrayHvd","like")}=2'
              name: 'Status: Device has "arrayHvd" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: d474c312d7cb47dca46215a8eac744d7
              expression: '{count(#3,"batteryHvd","like")}=2'
              name: 'Status: Device has "batteryHvd" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: 0bc65fdaba0347c189ffcb8a85060a80
              expression: '{count(#3,"customSettingsEdit","like")}=2'
              name: 'Status: Device has "customSettingsEdit" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: 5be2095eb503487fb87c9805f5ac32a9
              expression: '{count(#3,"dipSwitchChange","like")}=2'
              name: 'Status: Device has "dipSwitchChange" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: 2b92c44ce1434382a30a8bd72ad770dd
              expression: '{count(#3,"eepromRetryLimit","like")}=2'
              name: 'Status: Device has "eepromRetryLimit" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: 5ecb5879b4ec41dcaead83e4472912bf
              expression: '{count(#3,"fetShort","like")}=2'
              name: 'Status: Device has "fetShort" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: 60c900d102404cc2896f60599bf87f66
              expression: '{count(#3,"overcurrent","like")}=2'
              name: 'Status: Device has "overcurrent" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: dc57d706f3164ecfa055df95099afab5
              expression: '{count(#3,"rtsDisconnected","like")}=2'
              name: 'Status: Device has "rtsDisconnected" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: a6eed81fe971484f8ed2299985a08918
              expression: '{count(#3,"rtsShorted","like")}=2'
              name: 'Status: Device has "rtsShorted" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: 0081a97164b0465fb4cd87797890bbe4
              expression: '{count(#3,"slaveControlTimeout","like")}=2'
              name: 'Status: Device has "slaveControlTimeout" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: c3ab54f9715f4aed9937f47126d5d6a8
              expression: '{count(#3,"softwareFault","like")}=2'
              name: 'Status: Device has "softwareFault" faults flag'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
        -
          uuid: 5f1e79c9987648c8abb325a507209a07
          name: 'Status: Uptime'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.2.1.1.3.0
          key: status.uptime
          history: 7d
          units: uptime
          description: 'Device uptime in seconds'
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.01'
          tags:
            -
              tag: Application
              value: Status
          triggers:
            -
              uuid: 202ecd36f05041d996a379512f7ebb13
              expression: '{last()}<10m'
              name: 'Status: Device has been restarted (uptime < 10m)'
              priority: INFO
              description: 'Uptime is less than 10 minutes'
              manual_close: 'YES'
            -
              uuid: 3d37f05d03a84225aad9ee449d96b4be
              expression: '{nodata(5m)}=1'
              name: 'Status: Failed to fetch data (or no data for 5m)'
              priority: WARNING
              description: 'Zabbix has not received data for items for the last 5 minutes'
              manual_close: 'YES'
        -
          uuid: c46896a6169142b59fc7f534f1981993
          name: 'Battery: Target Voltage'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.45.0
          key: 'target.voltage[targetRegulationVoltage.0]'
          history: 7d
          value_type: FLOAT
          units: V
          description: |
            MIB: TRISTAR-MPPT
            Description:Target Voltage
            Scaling Factor:0.0054931640625
            Units:V
            Range:[-10, 180.0]
            Modbus address:0x0033
          preprocessing:
            -
              type: MULTIPLIER
              parameters:
                - '0.005493164063'
            -
              type: REGEX
              parameters:
                - '^(\d+)(\.\d{1,2})?'
                - \1\2
          tags:
            -
              tag: Application
              value: Battery
        -
          uuid: 9aee4500f32a4016be4f137c948b3d67
          name: 'Temperature: Battery'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.48.0
          key: 'temp.battery[batteryTemperature.0]'
          history: 7d
          value_type: FLOAT
          units: C
          description: |
            MIB: TRISTAR-MPPT
            Description:Batt. Temp
            Scaling Factor:1.0
            Units:C
            Range:[-40, 80]
            Modbus address:0x0025
          tags:
            -
              tag: Application
              value: Temperature
          triggers:
            -
              uuid: 7f500c19098e4da3be72d2aef1edd4e9
              expression: '{min(5m)}>{$BATTERY.TEMP.MAX.CRIT}'
              name: 'Temperature: Critically high battery temperature (over {$BATTERY.TEMP.MAX.CRIT}C for 5m)'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: d46fd98d45df417da1870c3a22b81302
              expression: '{max(5m)}<{$BATTERY.TEMP.MIN.CRIT}'
              name: 'Temperature: Critically low battery temperature (below {$BATTERY.TEMP.MIN.WARN}C for 5m)'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: HIGH
            -
              uuid: b36fb5d052c1480c93ecdefe655d1022
              expression: '{min(5m)}>{$BATTERY.TEMP.MAX.WARN}'
              name: 'Temperature: High battery temperature (over {$BATTERY.TEMP.MAX.WARN}C for 5m)'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
              dependencies:
                -
                  name: 'Temperature: Critically high battery temperature (over {$BATTERY.TEMP.MAX.CRIT}C for 5m)'
                  expression: '{Morningstar TriStar MPPT SNMP:temp.battery[batteryTemperature.0].min(5m)}>{$BATTERY.TEMP.MAX.CRIT}'
            -
              uuid: d4e410b5677e4d3099bcdae6487a809d
              expression: '{max(5m)}<{$BATTERY.TEMP.MIN.WARN}'
              name: 'Temperature: Low battery temperature (below {$BATTERY.TEMP.MIN.WARN}C for 5m)'
              opdata: 'Current value: {ITEM.LASTVALUE1}'
              priority: WARNING
              dependencies:
                -
                  name: 'Temperature: Critically low battery temperature (below {$BATTERY.TEMP.MIN.WARN}C for 5m)'
                  expression: '{Morningstar TriStar MPPT SNMP:temp.battery[batteryTemperature.0].max(5m)}<{$BATTERY.TEMP.MIN.CRIT}'
        -
          uuid: ffed57b626254db6bcc0df6de51d39fa
          name: 'Temperature: Heatsink'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.4.1.33333.2.49.0
          key: 'temp.heatsink[heatsinkTemperature.0]'
          history: 7d
          value_type: FLOAT
          units: C
          description: |
            MIB: TRISTAR-MPPT
            Description:HS Temp
            Scaling Factor:1.0
            Units:C
            Range:[-40, 80]
            Modbus address:0x0023
          tags:
            -
              tag: Application
              value: Temperature
      discovery_rules:
        -
          uuid: 5c8910a7991240a9b586d0d87ef00d5d
          name: 'Battery voltage discovery'
          type: DEPENDENT
          key: battery.voltage.discovery
          delay: '0'
          description: 'Discovery for battery voltage triggers'
          item_prototypes:
            -
              uuid: 763cce63817f471095bdce7a6127b0bf
              name: 'Battery: Voltage{#SINGLETON}'
              type: SNMP_AGENT
              snmp_oid: 1.3.6.1.4.1.33333.2.36.0
              key: 'battery.voltage[batteryVoltage.0{#SINGLETON}]'
              history: 7d
              value_type: FLOAT
              units: V
              description: |
                MIB: TRISTAR-MPPT
                Description:Battery voltage
                Scaling Factor:0.0054931640625
                Units:V
                Range:[-10, 180.0]
                Modbus address:0x0018
              preprocessing:
                -
                  type: MULTIPLIER
                  parameters:
                    - '0.005493164063'
                -
                  type: REGEX
                  parameters:
                    - '^(\d+)(\.\d{1,2})?'
                    - \1\2
              tags:
                -
                  tag: Application
                  value: Battery
              trigger_prototypes:
                -
                  uuid: 0505158c108443d6a0a63722238ba08c
                  expression: '{min(5m)}>{#VOLTAGE.MAX.CRIT}'
                  name: 'Battery: Critically high battery voltage (over {#VOLTAGE.MAX.CRIT}V for 5m)'
                  opdata: 'Current value: {ITEM.LASTVALUE1}'
                  priority: HIGH
                -
                  uuid: b7f21ddd99744dfa8a7ae7e2df16c19e
                  expression: '{max(5m)}<{#VOLTAGE.MIN.CRIT}'
                  name: 'Battery: Critically low battery voltage (below {#VOLTAGE.MIN.CRIT}V for 5m)'
                  opdata: 'Current value: {ITEM.LASTVALUE1}'
                  priority: HIGH
                -
                  uuid: 2497eeb900dd47539a60f0a5342f7725
                  expression: '{min(5m)}>{#VOLTAGE.MAX.WARN}'
                  name: 'Battery: High battery voltage (over {#VOLTAGE.MAX.WARN}V for 5m)'
                  opdata: 'Current value: {ITEM.LASTVALUE1}'
                  priority: WARNING
                  dependencies:
                    -
                      name: 'Battery: Critically high battery voltage (over {#VOLTAGE.MAX.CRIT}V for 5m)'
                      expression: '{Morningstar TriStar MPPT SNMP:battery.voltage[batteryVoltage.0{#SINGLETON}].min(5m)}>{#VOLTAGE.MAX.CRIT}'
                -
                  uuid: ba2395fb09dc43aba0e7821f765e7942
                  expression: '{max(5m)}<{#VOLTAGE.MIN.WARN}'
                  name: 'Battery: Low battery voltage (below {#VOLTAGE.MIN.WARN}V for 5m)'
                  opdata: 'Current value: {ITEM.LASTVALUE1}'
                  priority: WARNING
                  dependencies:
                    -
                      name: 'Battery: Critically low battery voltage (below {#VOLTAGE.MIN.CRIT}V for 5m)'
                      expression: '{Morningstar TriStar MPPT SNMP:battery.voltage[batteryVoltage.0{#SINGLETON}].max(5m)}<{#VOLTAGE.MIN.CRIT}'
          graph_prototypes:
            -
              uuid: f95cafe8c2a744908e3a290b0b2f6252
              name: 'Battery: Voltage{#SINGLETON}'
              graph_items:
                -
                  drawtype: GRADIENT_LINE
                  color: 1A7C11
                  item:
                    host: 'Morningstar TriStar MPPT SNMP'
                    key: 'battery.voltage[batteryVoltage.0{#SINGLETON}]'
          master_item:
            key: 'battery.voltage.discovery[batteryVoltage.0]'
          preprocessing:
            -
              type: JAVASCRIPT
              parameters:
                - |
                  var v_range = [
                        [[0, 18], [12, 15, 11.5, 15.5]],
                        [[18, 36], [24, 30, 23, 31]],
                        [[36, 99], [48, 60, 46, 62]],
                    ],
                    result = [];
                  
                  for (var idx in v_range) {
                      if (v_range[idx][0][0] < value && value <= v_range[idx][0][1]) {
                          result = [{
                              '{#VOLTAGE.MIN.WARN}': parseInt({$VOLTAGE.MIN.WARN}) || v_range[idx][1][0],
                              '{#VOLTAGE.MAX.WARN}': parseInt({$VOLTAGE.MAX.WARN}) || v_range[idx][1][1],
                              '{#VOLTAGE.MIN.CRIT}': parseInt({$VOLTAGE.MIN.CRIT}) || v_range[idx][1][2],
                              '{#VOLTAGE.MAX.CRIT}': parseInt({$VOLTAGE.MAX.CRIT}) || v_range[idx][1][3],
                              '{#SINGLETON}': ''
                          }];
                          break;
                      }
                  }
                  
                  return JSON.stringify(result);
      macros:
        -
          macro: '{$BATTERY.TEMP.MAX.CRIT}'
          value: '60'
          description: 'Battery high temperature critical value'
        -
          macro: '{$BATTERY.TEMP.MAX.WARN}'
          value: '45'
          description: 'Battery high temperature warning value'
        -
          macro: '{$BATTERY.TEMP.MIN.CRIT}'
          value: '-20'
          description: 'Battery low temperature critical value'
        -
          macro: '{$BATTERY.TEMP.MIN.WARN}'
          value: '0'
          description: 'Battery low temperature warning value'
        -
          macro: '{$CHARGE.STATE.CRIT}'
          value: '4'
          description: fault
        -
          macro: '{$CHARGE.STATE.WARN}'
          value: '2'
          description: disconnect
        -
          macro: '{$LOAD.STATE.CRIT:"fault"}'
          value: '4'
          description: fault
        -
          macro: '{$LOAD.STATE.CRIT:"lvd"}'
          value: '3'
          description: lvd
        -
          macro: '{$LOAD.STATE.WARN:"disconnect"}'
          value: '5'
          description: disconnect
        -
          macro: '{$LOAD.STATE.WARN:"lvdWarning"}'
          value: '2'
          description: lvdWarning
        -
          macro: '{$LOAD.STATE.WARN:"override"}'
          value: '7'
          description: override
        -
          macro: '{$VOLTAGE.MAX.CRIT}'
        -
          macro: '{$VOLTAGE.MAX.WARN}'
        -
          macro: '{$VOLTAGE.MIN.CRIT}'
        -
          macro: '{$VOLTAGE.MIN.WARN}'
      valuemaps:
        -
          uuid: 3c6c60ef422c4788bf0c5b74ffab7ef0
          name: 'TriStar MPPT charge state'
          mappings:
            -
              value: '0'
              newvalue: Start
            -
              value: '1'
              newvalue: NightCheck
            -
              value: '2'
              newvalue: Disconnect
            -
              value: '3'
              newvalue: Night
            -
              value: '4'
              newvalue: Fault
            -
              value: '5'
              newvalue: Mppt
            -
              value: '6'
              newvalue: Absorption
            -
              value: '7'
              newvalue: Float
            -
              value: '8'
              newvalue: Equalize
            -
              value: '9'
              newvalue: Slave
  graphs:
    -
      uuid: 8cdd58f62fcc4ca89d114fbe7eddc26d
      name: 'Array: Voltage'
      graph_items:
        -
          drawtype: GRADIENT_LINE
          color: 1A7C11
          item:
            host: 'Morningstar TriStar MPPT SNMP'
            key: 'array.sweep_vmp[arrayVmpLastSweep.0]'
        -
          sortorder: '1'
          drawtype: GRADIENT_LINE
          color: 2774A4
          item:
            host: 'Morningstar TriStar MPPT SNMP'
            key: 'array.sweep_voc[arrayVocLastSweep.0]'
        -
          sortorder: '2'
          drawtype: GRADIENT_LINE
          color: F63100
          item:
            host: 'Morningstar TriStar MPPT SNMP'
            key: 'array.voltage[arrayVoltage.0]'
    -
      uuid: 067062eca2b34488a9defc3aa002c88c
      name: 'Battery: Current'
      graph_items:
        -
          drawtype: GRADIENT_LINE
          color: 1A7C11
          item:
            host: 'Morningstar TriStar MPPT SNMP'
            key: 'charge.current[batteryCurrent.0]'
    -
      uuid: 1889ace5679d4f63b59237812b5d0718
      name: 'Battery: Output Power (Watts)'
      graph_items:
        -
          drawtype: GRADIENT_LINE
          color: 1A7C11
          item:
            host: 'Morningstar TriStar MPPT SNMP'
            key: 'charge.output_power[ outputPower.0]'
    -
      uuid: 87918502df2743e1be04a02b02c44b61
      name: 'Temperature: Battery/Heatsink'
      graph_items:
        -
          drawtype: GRADIENT_LINE
          color: 1A7C11
          item:
            host: 'Morningstar TriStar MPPT SNMP'
            key: 'temp.battery[batteryTemperature.0]'
        -
          sortorder: '1'
          drawtype: GRADIENT_LINE
          color: 2774A4
          item:
            host: 'Morningstar TriStar MPPT SNMP'
            key: 'temp.heatsink[heatsinkTemperature.0]'
